From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Thu, 31 Oct 2019 16:14:41 -0700
Subject: [PATCH] Optimize entity list iteration requiring entities be in
 loaded chunks

We retain a list of loaded entities specifically for this usage

diff --git a/src/main/java/net/minecraft/server/Chunk.java b/src/main/java/net/minecraft/server/Chunk.java
index 1d49034b803a051440766a4b62a2616cb31a1ed2..5b027da1cf5189197fcecd488c3ae781b2a58abc 100644
--- a/src/main/java/net/minecraft/server/Chunk.java
+++ b/src/main/java/net/minecraft/server/Chunk.java
@@ -144,20 +144,11 @@ public class Chunk implements IChunkAccess {
     // CraftBukkit end
 
     /* Concrete start */
+    public final ca.spottedleaf.concrete.util.EntityList entityList = new ca.spottedleaf.concrete.util.EntityList();
     public void forEachEntity(final Consumer<Entity> consumer) {
-        final List<Entity>[] slices = this.entitySlices;
-        for (int i = 0, slicesLen = slices.length; i < slicesLen; ++i) {
-            final org.bukkit.craftbukkit.util.UnsafeList<Entity> slice = (org.bukkit.craftbukkit.util.UnsafeList)slices[i];
-
-            if (slice == null) {
-                continue;
-            }
-
-            final Object[] data = slice.getRawDataArray();
-
-            for (int j = 0, sliceLen = slice.size(); j < sliceLen; ++j) {
-                consumer.accept((Entity)data[j]);
-            }
+        final Entity[] entities = this.entityList.getRawData();
+        for (int i = 0, size = this.entityList.size(); i < size; ++i) {
+            consumer.accept(entities[i]);
         }
     }
 
@@ -493,6 +484,12 @@ public class Chunk implements IChunkAccess {
         entity.chunkY = k;
         entity.chunkZ = this.loc.z;
         this.entitySlices[k].add(entity);
+        /* Concrete start - per chunk entity list */
+        this.entityList.add(entity);
+        if (this.loadedTicketLevel) {
+            ((WorldServer)this.world).loadedEntities.add(entity);
+        }
+        /* Concrete end - per chunk entity list */
         // Paper start
         if (entity instanceof EntityItem) {
             itemCounts[k]++;
@@ -531,6 +528,7 @@ public class Chunk implements IChunkAccess {
         if (!this.entitySlices[i].remove(entity)) {
             return;
         }
+        this.entityList.remove(entity); /* Concrete - per chunk entity list */
         if (entity instanceof EntityItem) {
             itemCounts[i]--;
         } else if (entity instanceof IInventory) {
@@ -711,6 +709,7 @@ public class Chunk implements IChunkAccess {
         }
         this.loadedTicketLevel = true;
         chunkProvider.addLoadedChunk(this);
+        ((WorldServer)this.world).onChunkLoad(this);
         /* Concrete end - neighbour cache */
         org.bukkit.Server server = this.world.getServer();
         if (server != null) {
@@ -767,6 +766,7 @@ public class Chunk implements IChunkAccess {
         }
         this.loadedTicketLevel = false;
         chunkProvider.removeLoadedChunk(this);
+        ((WorldServer)this.world).onChunkUnload(this);
         this.resetNeighbours();
         /* Concrete end - neighbour cache */
     }
diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 20133cb44b23fdb3da83cf60461bf1c0afab5358..9ed79eb3ff00529aeda38466891a26b72616a31f 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -170,6 +170,26 @@ public class WorldServer extends World {
     }
     // Paper end
 
+
+    /* Concrete start */
+    public final ca.spottedleaf.concrete.util.EntityList loadedEntities = new ca.spottedleaf.concrete.util.EntityList();
+    void onChunkLoad(final Chunk chunk) {
+        final ca.spottedleaf.concrete.util.EntityList list = chunk.entityList;
+        final Entity[] entities = list.getRawData();
+        for (int i = 0, size = list.size(); i < size; ++i) {
+            this.loadedEntities.add(entities[i]);
+        }
+    }
+
+    void onChunkUnload(final Chunk chunk) {
+        final ca.spottedleaf.concrete.util.EntityList list = chunk.entityList;
+        final Entity[] entities = list.getRawData();
+        for (int i = 0, size = list.size(); i < size; ++i) {
+            this.loadedEntities.remove(entities[i]);
+        }
+    }
+    /* Concrete end */
+
     // Add env and gen to constructor
     public WorldServer(MinecraftServer minecraftserver, Executor executor, WorldNBTStorage worldnbtstorage, WorldData worlddata, DimensionManager dimensionmanager, GameProfilerFiller gameprofilerfiller, WorldLoadListener worldloadlistener, org.bukkit.World.Environment env, org.bukkit.generator.ChunkGenerator gen) {
         super(worlddata, dimensionmanager, (world, worldprovider) -> {
@@ -458,14 +478,13 @@ public class WorldServer extends World {
 
             gameprofilerfiller.exitEnter("regular");
             this.tickingEntities = true;
-            ObjectIterator objectiterator = this.entitiesById.int2ObjectEntrySet().fastIterator(); /* Concrete - use fast iterator to reduce entry creation */
+            Iterator<Entity> objectiterator = this.loadedEntities.iterator(); /* Concrete - use fast iterator to reduce entry creation */ /* Concrete - use loaded entity list */
 
             org.spigotmc.ActivationRange.activateEntities(this); // Spigot
             timings.entityTick.startTiming(); // Spigot
             TimingHistory.entityTicks += this.globalEntityList.size(); // Paper
             while (objectiterator.hasNext()) {
-                Entry<Entity> entry = (Entry) objectiterator.next();
-                Entity entity1 = (Entity) entry.getValue();
+                Entity entity1 = (Entity) objectiterator.next(); /* Concrete - use loaded entity list */
                 Entity entity2 = entity1.getVehicle();
 
                 /* CraftBukkit start - We prevent spawning in general, so this butchering is not needed
@@ -502,7 +521,7 @@ public class WorldServer extends World {
                 gameprofilerfiller.enter("remove");
                 if (entity1.dead) {
                     this.removeEntityFromChunk(entity1);
-                    objectiterator.remove();
+                    objectiterator.remove(); this.entitiesById.remove(entity1.getId()); /* Concrete - use loaded entity list */
                     this.unregisterEntity(entity1);
                 }
 
@@ -1428,6 +1447,7 @@ public class WorldServer extends World {
         if (entity instanceof EntityInsentient) {
             this.navigators.remove(((EntityInsentient) entity).getNavigation());
         }
+        this.loadedEntities.remove(entity); /* Concrete - loaded entity list */
         new com.destroystokyo.paper.event.entity.EntityRemoveFromWorldEvent(entity.getBukkitEntity()).callEvent(); // Paper - fire while valid
         entity.valid = false; // CraftBukkit
     }
@@ -1484,6 +1504,11 @@ public class WorldServer extends World {
             }
             // Paper end
             entity.shouldBeRemoved = false; // Paper - shouldn't be removed after being re-added
+            /* Concrete start - loaded entity list */
+            if (this.isChunkLoaded(ca.spottedleaf.concrete.util.Util.getChunkCoordinate(entity.locX()), ca.spottedleaf.concrete.util.Util.getChunkCoordinate(entity.locZ()))) {
+                this.loadedEntities.add(entity);
+            }
+            /* Concrete end - loaded entity list */
             new com.destroystokyo.paper.event.entity.EntityAddToWorldEvent(entity.getBukkitEntity()).callEvent(); // Paper - fire while valid
         }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index 0c2f7bd95590298635ccb7885be681645ddbfbb7..038dddf6bbe8abf29bd35e93732b4599744ab502 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -1080,16 +1080,16 @@ public class CraftWorld implements World {
 
     @Override
     public List<Entity> getEntities() {
-        List<Entity> list = new ArrayList<Entity>();
+        List<Entity> list = new ArrayList<Entity>(world.loadedEntities.size()); /* Concrete - optimize this call */
 
-        for (Object o : world.entitiesById.values()) {
+        for (Object o : world.loadedEntities) { /* Concrete - optimize this call */
             if (o instanceof net.minecraft.server.Entity) {
                 net.minecraft.server.Entity mcEnt = (net.minecraft.server.Entity) o;
                 if (mcEnt.shouldBeRemoved) continue; // Paper
                 Entity bukkitEntity = mcEnt.getBukkitEntity();
 
                 // Assuming that bukkitEntity isn't null
-                if (bukkitEntity != null && bukkitEntity.isValid()) {
+                if (bukkitEntity != null && CraftEntity.canBeSeenByPlugins(bukkitEntity)) { /* Concrete - optimize this call */
                     list.add(bukkitEntity);
                 }
             }
@@ -1100,16 +1100,16 @@ public class CraftWorld implements World {
 
     @Override
     public List<LivingEntity> getLivingEntities() {
-        List<LivingEntity> list = new ArrayList<LivingEntity>();
+        List<LivingEntity> list = new ArrayList<LivingEntity>(world.loadedEntities.size()); /* Concrete - optimize this call */
 
-        for (Object o : world.entitiesById.values()) {
+        for (Object o : world.loadedEntities) { /* Concrete - optimize this call */
             if (o instanceof net.minecraft.server.Entity) {
                 net.minecraft.server.Entity mcEnt = (net.minecraft.server.Entity) o;
                 if (mcEnt.shouldBeRemoved) continue; // Paper
                 Entity bukkitEntity = mcEnt.getBukkitEntity();
 
                 // Assuming that bukkitEntity isn't null
-                if (bukkitEntity != null && bukkitEntity instanceof LivingEntity && bukkitEntity.isValid()) {
+                if (bukkitEntity != null && bukkitEntity instanceof LivingEntity && CraftEntity.canBeSeenByPlugins(bukkitEntity)) { /* Concrete - optimize this call */
                     list.add((LivingEntity) bukkitEntity);
                 }
             }
@@ -1130,7 +1130,7 @@ public class CraftWorld implements World {
     public <T extends Entity> Collection<T> getEntitiesByClass(Class<T> clazz) {
         Collection<T> list = new ArrayList<T>();
 
-        for (Object entity: world.entitiesById.values()) {
+        for (Object entity: world.loadedEntities) { /* Concrete - optimize this call */
             if (entity instanceof net.minecraft.server.Entity) {
                 if (((net.minecraft.server.Entity) entity).shouldBeRemoved) continue; // Paper
                 Entity bukkitEntity = ((net.minecraft.server.Entity) entity).getBukkitEntity();
@@ -1141,7 +1141,7 @@ public class CraftWorld implements World {
 
                 Class<?> bukkitClass = bukkitEntity.getClass();
 
-                if (clazz.isAssignableFrom(bukkitClass) && bukkitEntity.isValid()) {
+                if (clazz.isAssignableFrom(bukkitClass) && CraftEntity.canBeSeenByPlugins(bukkitEntity)) { /* Concrete - optimize this call */
                     list.add((T) bukkitEntity);
                 }
             }
@@ -1154,7 +1154,7 @@ public class CraftWorld implements World {
     public Collection<Entity> getEntitiesByClasses(Class<?>... classes) {
         Collection<Entity> list = new ArrayList<Entity>();
 
-        for (Object entity: world.entitiesById.values()) {
+        for (Object entity: world.loadedEntities) { /* Concrete - optimize this call */
             if (entity instanceof net.minecraft.server.Entity) {
                 if (((net.minecraft.server.Entity) entity).shouldBeRemoved) continue; // Paper
                 Entity bukkitEntity = ((net.minecraft.server.Entity) entity).getBukkitEntity();
@@ -1167,7 +1167,7 @@ public class CraftWorld implements World {
 
                 for (Class<?> clazz : classes) {
                     if (clazz.isAssignableFrom(bukkitClass)) {
-                        if (bukkitEntity.isValid()) {
+                        if (CraftEntity.canBeSeenByPlugins(bukkitEntity)) { /* Concrete - optimize this call */
                             list.add(bukkitEntity);
                         }
                         break;
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index dfa15372b8bbe0f53a1ec8bd40934ed4ce6f43e1..51930897a3db20d2a1bf28340d3d510070420a3b 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -180,6 +180,18 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         this.entity = entity;
     }
 
+    /* Concrete start */
+    // note: this does not check isChunkLoaded, use Entity#isValid to do that
+    public static boolean canBeSeenByPlugins(org.bukkit.entity.Entity entity) {
+        Entity handle = ((CraftEntity)entity).getHandle();
+        // TODO
+        // isAlive is a dumb choice, given living entities aren't alive (but are in the world) if health < 0
+        // this needs to be brought up to spigot to fix though, we are NOT breaking api implementation, especially
+        // if no-one's complained.
+        return !handle.shouldBeRemoved && handle.isAlive() && handle.valid;
+    }
+    /* Concrete end */
+
     @Override
     public Chunk getChunk() {
         net.minecraft.server.Chunk currentChunk = entity.getCurrentChunk();
